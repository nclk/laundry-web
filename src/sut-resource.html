<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/progress-bar/progress-bar.html">

<link rel="import" href="shared-styles.html">

<dom-module id="sut-resource">
    <template>
        <style include="shared-styles"></style>
        <style>
            :host {
                display: block;
                margin: 25px;
            }
        </style>
        <iron-ajax
                id="ajax"
                auto
                params
                on-response="_handleAjaxResponse"
                on-error="_handleAjaxError"
                on-request="_handleAjaxRequest"
                handle-as="json"
                last-response="{{resource}}"
                debounce-duration="300"></iron-ajax>

        <iron-pages
                id="iron-pages"
                selected="[[page]]"
                attr-for-selected="name"
                role="XXX">
            <sut-program 
                    name="sut-program"
                    sut-api-base="{{sutApiBase}}"
                    relation="[[resourceType.relation]]"
                    program="[[resource]]">
            </sut-program>
            <sut-test_run
                    name="sut-test_run"
                    sut-api-base="{{sutApiBase}}"
                    relation="[[resourceType.relation]]"
                    test-run="[[resource]]">
            </sut-test_run>
            <div name="unknown">Unknown resource type...</div>
            <progress-bar name="progress-bar"></progress-bar>
            <http-404 name="http-404"></http-404>
            <http-500 name="http-500"></http-500>
        </iron-pages>
    </template>
    <script>
        class SutResource extends Polymer.Element {
            static get is() { return "sut-resource"; }

            static get properties() {
                return {
                    sutApiBase: String,
                    resource: {
                        type: Object,
                        value: () => { return {}; },
                        observer: "_resourceChanged"
                    },
                    relation: {
                        type: String
                    },
                    page: {
                        type: String,
                        observer: "_pageChanged"
                    }
                };
            };

            _resourceChanged(resource) {
                if (!Object.keys(resource).length) {
                    this.page = "progress-bar";

                    //setTimeout(() => {
                    this.$.ajax.url = [
                        this.resourceType.href,
                        this.identifier
                    ].join("")
                    //}, 2000);
                }
                else this.page = [
                    "sut", this.resourceType.relation
                ].join("-")
            }

            _pageChanged(page) {
                if (~["progress-bar"].indexOf(page))
                    return;
    
                var resolvedPageUrl = this.resolveUrl(page + ".html");
    
                Polymer.importHref(
                        resolvedPageUrl,
                        (() => this.page === page &&
                            this.$["iron-pages"].select(page)),
                        (() => this.page === page &&
                            this.$["iron-pages"].select("http-404")),
                        true);
            }

            _showPage404(page) {
                this.page = this.page === page
                    ? "http-404"
                    : this.page;
            }

            _handleAjaxResponse(e, req) {
                //console.log(this.resource);
            }

            _handleAjaxError(e, req) {
                //
            }

            _handleAjaxRequest(e, req) {
                //
            }

        }

        customElements.define(SutResource.is, SutResource);
    </script>
</dom-module>
