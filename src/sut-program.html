<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-form/iron-form.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">

<link rel="import" href="nclk-config-editor.html">

<dom-module id="sut-program">
    <template>
        <style>
            paper-button {
                background-color: var(--app-primary-color);
                text-align: center;
                color: #fff;
                margin: 0;
            }
            #title {
                padding: 5px;
                margin-bottom: 15px;
            }
            h2 {
                margin-right: 5px;
                margin: 0px;
            }
            paper-material {
                border-radius: 3px;
                color: orange;
            }
            paper-material span { color: #888 }
        </style>

        <iron-ajax
                id="ajax"
                params
                url="{{sutApiBase}}/actions/run"
                handle-as="json"
                last-response="{{testRun}}"
                debounce-duration="300"></iron-ajax>

        <paper-material id="title" elevation="0">
            <h2>[[program.name]]</h2>
            <span>[[program.documentation.description]]</span>
        </paper-material>

        <iron-form id="form">
            <form method="post" action$="{{sutApiBase}}/actions/run">
                <paper-button style="" raised on-click="_submit">Run</paper-button>
                <template is="dom-repeat" items="[[configProfiles]]">
                    <nclk-config-editor
                            id="[[_envName(item)]]"
                            name="[[_envName(item)]]"
                            default="[[_default(item, env)]]"
                            config-profile="{{item}}">
                    </nclk-config-editor>
                </template>
            </form>
        </iron-form>
    </template>
    <script>
        class SutProgram extends Polymer.Element {
            static get is() { return "sut-program"; }

            static get properties() {
                return {
                    program: {
                        type: Object,
                        observer: "_programChanged"
                    },
                    configProfiles: {
                        type: Array,
                        observer: "_configProfilesChanged"
                    },
                    env: {
                        type: Object,
                        value: null
                    },
                    testRun: {
                        type: Object,
                        observer: "_testRunChanged",
                        notify: true
                    }
                };
            }

            ready() {
                super.ready();
                var req = this.$.form.request = this.$.ajax;
                this.$.form.addEventListener("iron-form-presubmit", e => {
                    const body = {
                        program_name: this.program.name,
                        harvest_keys: [ "$bot" ],
                        env: [ this.$.form.serializeForm() ]
                    };
                    req.contentType = "application/json";
                    req.body = JSON.stringify(body);
                    req.method = "post";
                    //e.preventDefault();
                    //console.log(body);
                });
            }

            _default(item, env) {
                let data = env && env[Object.keys(item.data)[0]];
                return data;
            }

            _configProfilesChanged(cps) {
                console.log(cps);
            }

            _testRunChanged(tr) {
                window.history.pushState({}, null, "/test-runs/" + tr.test_run_id);
                window.dispatchEvent(new CustomEvent('location-changed'));
                // XXX: in order for the above to work, we need selectedResource and 
                // selectedResourceType to change in resource-list.html, which will
                // probably require some kind of change to sut-app.html
                //window.location.href = "/test-runs/" + tr.test_run_id;
            }

            _envName(item) {
                return Object.keys(item.data)[0];
            }

            _submit(e) {
                //this.$.form.noValidate = true;
                this.$.form.submit();
            }

            _handleConfigProfiles(e) {
                this.set(
                    "configProfiles",
                    JSON.parse(JSON.stringify(e.target.lastResponse.results)).sort(
                        (a, b) => a.name.localeCompare(b.name)
                    )
                );
            }

            _handleConfigProfileProgramMaps(e) {
                if (e.target.lastResponse) {
                    let $ajax = this.$.ajax.cloneNode(true);
                    $ajax.url = [
                        this.sutApiBase,
                        "/config-profiles/?name=",
                        e.target.lastResponse.results.map(
                            x => x.config_profile
                        ).join("&name=")
                    ].join("");
                    $ajax.addEventListener(
                        "response",
                        this._handleConfigProfiles.bind(this)
                    );
                    $ajax.generateRequest();
                }
            }

            _programChanged(program) {
                if (program) {
                    //if (this.env) {
                    //    return this.configProfiles = Object.keys(this.env).map(
                    //        (key) => {
                    //            let entry = {};
                    //            entry[key] = this.env[key];
                    //            return { data: entry };
                    //        }
                    //    );
                    //}
                    const $ajax = this.$.ajax.cloneNode(true);
                    $ajax.url = program["related-resources"][
                        "config-profile-program-maps"
                    ];
                    $ajax.addEventListener(
                        "response",
                        this._handleConfigProfileProgramMaps.bind(this)
                    );
                    $ajax.generateRequest();
                }
            }
        }
        customElements.define(SutProgram.is, SutProgram);
    </script>
</dom-module>
