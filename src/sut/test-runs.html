<link rel="import" href="/lib/nclk/hoquet.html">
<link rel="import" href="/src/sut/master-detail.html">
<link rel="import" href="/src/sut/test-run-list-item.html">

<template>
    <style>
        ol {
            list-style-type: none;
            margin: 0;
            padding: 0;
        }
        sut-test-run-list-item {
            float: left;
            /*width: 200px;*/
        }
        sut-test-run-list-item:hover {
            background: #fff;
            transition: all 0.5s ease-out;
        }
    </style>
</template>

<script>
(() => {

    const ownerDocument = (
        document._currentScript || document.currentScript
    ).ownerDocument;
    const _template = ownerDocument.querySelector("template");

    class TestRuns extends Sut.MasterDetail {

        constructor() {
            super();

            this.shadowRoot.appendChild(
                document.importNode(_template.content, true)
            );

            Object.defineProperties(this, {
                $list: {
                    value: document.createElement("ol")
                },
                $detail: {
                    value: document.createElement("div")
                }
            });

            this.containers = [this.$list, this.$detail];

            this.$route.pattern = "/:name";
            this.order = "created";
            this.direction = "desc";
            this.idPredicate = x => (
                x["id"] === this.$route.data["id"]
            );
        }

        resourceReceivedPipeline(r) { }

        async init() {
            let subtitle = "Test Runs";

            this.resultSet = {};

            if (this.$route.active) {
                const $testRun = new Sut.TestRun(await this.selectedResource);
                this.$detail.firstChild && this.$detail.removeChild(
                    this.$detail.firstChild);
                this.$detail.appendChild($program);
                this.$pages.select("detail");
                subtitle += `&nbsp;&raquo; ${(await this.selectedResource).name}`
                $program.init();
            } else {
                const programs = await this.resources;

                while (this.$list.firstChild)
                    this.$list.removeChild(this.$list.firstChild);

                programs.results.forEach(p => {
                    this.appendTestRun(p);
                });

                this.$pages.select("master");
            }
            this.dispatchEvent(new CustomEvent("subtitle-change", {
                detail: {
                    subtitle: subtitle
                },
                composed: true
            }));
        }

        appendTestRun(program) {
            const $li = document.createElement("li");
            const $program = new Sut.TestRunListItem(program);
            $li.appendChild($program);
            this.$list.appendChild($li);
        }
    }

    window.Sut.TestRuns = TestRuns;
    window.customElements.define("sut-test-runs", TestRuns);

})();
</script>
