<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-form/iron-form.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-material/paper-material.html">

<link rel="import" href="nclk-config-editor.html">

<dom-module id="sut-test_run">
    <template>
        <style>
            paper-button {
                background-color: var(--app-primary-color);
                text-align: center;
                color: #fff;
                margin: 0;
            }
            #title {
                padding: 5px;
                margin-bottom: 15px;
            }
            h2 {
                color: orange;
                margin-right: 5px;
                margin: 0px;
            }
            h2 span { color: #888; }
            paper-material {
                border-radius: 3px;
                background: #fff;
                margin: 8px 0;
            }
            paper-material span { color: #888 }
            span.url { font-weight: bold; color: #555; };
            li.field { padding: 5px 10px; }
            span.status { color: #888; }
            span.status-running { color: orange; }
            span.status-failed { color: red; }
            span.status-passed { color: green; }
        </style>

        <!-- XXX: below `paper-material` needed for nclk-config-editor...why? -->
        <paper-material elevation="0"></paper-material>
        <iron-ajax
                id="harvestajax"
                auto
                params
                handle-as="json"
                on-response="_handleHarvests"
                debounce-duration="300"></iron-ajax>

        <iron-ajax
                id="testrunajax"
                auto
                params
                handle-as="json"
                last-response="{{testRun}}"
                debounce-duration="300"></iron-ajax>

        <h2>
            <span>Test run of </span>
            [[testRun.program_name]]
        </h2>
        <span>[[_formatDate(testRun.created)]]</span>

        <h3>Status: <span class="status">[[testRun.status]]</span></h3>
        <h3>Configuration:</h3>
        <paper-material elevation="1">
            <ul name="environment-report"
                style="list-style: none outside none; padding: 0">
                <template is="dom-repeat" items="[[_environmentReports(testRun)]]">
                    <paper-material elevation="1">
                        <li class="field">
                            <span class="url">[[item.title]]:</span>
                            <span>[[item.value]]</span>
                        </li>
                    </paper-material>
                </template>
            </ul>
        </paper-material>
        <h3>Results:</h3>
        <progress-bar id="progress"></progress-bar>
        <template is="dom-repeat" items="[[harvests]]">
            <h3>
                <span class$="status status-[[_statusClass(testRun)]]">
                    [[item.title]]
                </span>
            </h3> 
            <ul style="list-style: none inside none; padding: 0px;">
                <template is="dom-repeat" items="[[item.fields]]">
                    <paper-material elevation="1">
                        <li class="field">
                            <span class="url">[[item.title]]:</span>
                            <span><pre>[[item.value]]</pre></span>
                        </li>
                    </paper-material>
                </template>
            </ul>
        </template>

        <!-- <iron-form id="form">
            <form method="post" action$="{{sutApiBase}}/actions/run">
                <paper-button style="" raised on-click="_submit">Run</paper-button>
                <template is="dom-repeat" items="[[configProfiles]]">
                    <nclk-config-editor
                            name="[[_envName(item)]]"
                            config-profile="{{item}}">
                    </nclk-config-editor>
                </template>
            </form>
        </iron-form> -->
    </template>
    <script>
        class SutTestRun extends Polymer.Element {
            static get is() { return "sut-test_run"; }

            static get properties() {
                return {
                    testRun: {
                        type: Object,
                        observer: "_testRunChanged"
                    },
                    harvests: {
                        type: Array,
                        value: () => []
                    },
                    testPollTimeout: {
                        type: Number
                    },
                    testRunChangedListener: {
                        type: Function
                    },
                    relation: {
                        type: String
                    }
                };
            }

            ready() {
                super.ready();
            }

            _isTestRun(tr) {
                return tr && this.relation === "test_run";
            }

            _environmentReports(testRun) {
                if (!this._isTestRun(testRun))
                    return;

                return Object.keys(testRun.env).map((x) => {
                    const val = testRun.env[x];
                    return {
                        title: x,
                        value: Array.isArray(val) ?
                            testRun.env[x].map((y) => {
                                return y.name || y;
                            }).join(", ")
                            : typeof val === "object"
                            ? JSON.stringify(val, false, 4)
                            : val
                    };
                }).sort((a, b) => {
                    return a.title < b.title ?
                        -1 : 1;
                });
            }

            _statusClass(tr) {
                return tr.status === "running"
                    ? "running"
                    : tr.status === "complete"
                        ? !tr.num_failures
                            ? "passed"
                            : "failed"
                    : "failed";
            }

            _formatDate(dt) {
                return new Date(dt).toLocaleString();
            }

            _envName(item) {
                return Object.keys(item.data)[0];
            }

            _handleHarvests(e) {
                try {
                    //console.log(e.target.lastResponse.results[0].data);
                    this.harvests = e.target.lastResponse.results[0].data;
                }
                catch (e) {
                    this.harvests = [];
                }
            }

            _testRunChanged(testRun) {
                this.harvests = [];
                this.$.progress.style.display = "none";

                if (this._isTestRun(testRun)) {
                    const $harvestajax = this.$.harvestajax;
                    const $testrunajax = this.$.testrunajax;
                    const dt = (new Date()).getTime();
                
                    if (testRun.status === "complete") {
                        $harvestajax.url = testRun["related-resources"][
                            "harvests"
                        ] + "&_=" + dt;
                    }
                    else this.harvests = [];

                    if (testRun.status.toLowerCase() === "running") {
                        this.$.progress.style.display = "";
                        setTimeout(() => {
                            $testrunajax.url = testRun.href + "?_=" + dt;
                        }, 5000);
                    }
                }
            }
        }
        customElements.define(SutTestRun.is, SutTestRun);
    </script>
</dom-module>
