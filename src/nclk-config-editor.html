<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-material/paper-material.html">
<link rel="import" href="../bower_components/paper-tooltip/paper-tooltip.html">

<dom-module id="nclk-config-editor">
    <template>
        <style>
            :host {
                display: block;
                position: relative;
            }

            paper-material[name] {
                margin: 20px 0;
                border-radius: 3px;
            }
            paper-material label {
                display: block;
            } 
            paper-material {
                padding: 10px;
                background-color: #f5f5f5;
                display: block;
            }
            paper-material.iron-selected {
            }
            paper-checkbox {
                padding: 10px 10px;
                min-width: 200px;
                max-width: 200px;
                --paper-checkbox-checked-color: #888;
            }
            paper-checkbox:hover {
                box-shadow: 0 0 5px var(--app-primary-color);
            }
            label {
                font-size: 1.5em;
                /* XXX: font-size: var(--paper-font-caption_-_font-size);*/
            }
            .all-none { color: blue; }
            .all-none-container { display: inline-block; padding: 0 5px;}
        </style>

        <paper-tooltip position="top">
            [[configProfile.documentation.description]]
        </paper-tooltip>
        <iron-pages
                selected="[[type]]"
                attr-for-selected="name"
                role="XXX"
                fallback-selection="other"
                id="iron-pages">

            <paper-input
                    name="object"
                    disabled
                    value="[[_str(value)]]"
                    label="[[configProfile.name]]">
            </paper-input>

            <paper-material
                    elevation="1"
                    animated
                    name="array"
                    on-mouseleave="_drop"
                    on-mouseenter="_pop">
                <div>
                    <label>
                        [[configProfile.name]]
                    </label>
                    <span class="all-none-container">
                    <paper-button on-tap= "_selectAll" class="all-none">all</paper-button>
                    <paper-button on-tap="_clearAll" class="all-none">none</paper-button>
                    </span>
                </div>
                <template is="dom-if" if="[[_isList(type)]]">
                    <template is="dom-repeat" items="[[value]]">
                        <paper-checkbox
                                on-change="_arrayChanged"
                                value="[[item]]"
                                checked="[[!item.$meta.optional]]"
                                name="[[configProfile.name]]">
                            [[_named(item)]]
                        </paper-checkbox>
                    </template>
                </template>
            </paper-material>

            <paper-material
                    elevation="1"
                    animated
                    name="other"
                    on-mouseleave="_drop"
                    on-mouseenter="_pop">
                <paper-input
                        on-change="_otherChanged"
                        label="[[configProfile.name]]"
                        disabled="[[configProfile.meta.read-only]]"
                        name="[[configProfile.name]]"
                        value="[[_data(configProfile)]]">
                </paper-input>
            </paper-material>
        </iron-pages>

    </template>
    <script>
        class NclkConfigEditor extends Polymer.mixinBehaviors([
            Polymer.IronFormElementBehavior
        ], Polymer.Element) {
            static get is() { return "nclk-config-editor"; }

            static get properties() {
                return {
                    configProfile: {
                        type: Object,
                        observer: "_configProfileChanged",
                        notify: true
                    }
                };
            }

            _str(val) {
                return JSON.stringify(val, false, 2);
            }

            _checkboxes() {
                return this.checkboxes = this.checkboxes
                    ? this.checkboxes
                    : this.shadowRoot.querySelectorAll("paper-checkbox");
            }

            _clearAll(e) {
                Array.prototype.forEach.call(this._checkboxes(), x =>
                    x.checked = false
                );
                this.value.splice(0, this.value.length);
            }

            _selectAll(e) {
                this._clearAll();
                Array.prototype.map.call(this._checkboxes(), x =>
                    (x.checked = true) && this.value.push(x.value)
                );
            }

            _bundle(cp, item) {
                return [cp,item];
            }

            _otherChanged(e) {
                const val = e.target.value;
                const parsed = parseInt(val);
                if (parsed)
                    this.value = parsed;
                else this.value = val;
            }

            _arrayChanged(e) {
                const val = e.target.value;
                const on = e.target.checked;
                if (on) this.value.push(val);
                else this.value.splice(this.value.indexOf(val), 1);
            }

            _pop(e) {
                e.target.elevation = 3;
            }

            _drop(e) {
                e.target.elevation = 1;
            }

            _isList(type) {
                return type === "array";
            }

            _named(item) {
                return item && item.name || item;
            }

            _data(cp) {
                return cp.data[Object.keys(cp.data)[0]];
            }

            _toType(obj) {
                return ({}).toString.call(obj).match(/\s([a-zA-Z]+)/)[1].toLowerCase()
            }

            _type() {
                return ({})
                    .toString
                    .call(this.value)
                    .match(/\s([a-zA-Z]+)/)[1]
                    .toLowerCase()
            }

            _filterOptional() {
                if (this.type === "array") {
                    var copy = this.value.slice();
                    copy.forEach(
                        x => x.$meta && x.$meta.optional &&
                            this.value.splice(this.value.indexOf(x), 1)
                    );
                }
            }

            _configProfileChanged(cp) {
                this.value = this._data(cp);
                this.type = this._type();
                if (this.type === "array") {
                    this.value.sort((a, b) =>
                        typeof a.name === "string"
                            ? a.name.localeCompare(b.name)
                            : a.localeCompare(b)
                    );
                }
                setTimeout(this._filterOptional.bind(this), 0);
            }

        }
        customElements.define(NclkConfigEditor.is, NclkConfigEditor);
    </script>
</dom-module>
