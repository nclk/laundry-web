<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-material/paper-material.html">
<link rel="import" href="../bower_components/paper-tooltip/paper-tooltip.html">

<link rel="import" href="type.html">

<dom-module id="nclk-config-editor">
    <template>
        <style>
            :host {
                display: block;
                position: relative;
            }

            paper-material[name] {
                margin: 20px 0;
                border-radius: 3px;
            }
            paper-material label {
                display: block;
            } 
            paper-material {
                padding: 10px;
                background-color: #f5f5f5;
                display: block;
            }
            paper-material.iron-selected {
            }
            paper-checkbox {
                padding: 10px 10px;
                min-width: 200px;
                max-width: 200px;
                --paper-checkbox-checked-color: #888;
            }
            paper-checkbox:hover {
                box-shadow: 0 0 5px var(--app-primary-color);
            }
            label {
                font-size: 1.5em;
                /* XXX: font-size: var(--paper-font-caption_-_font-size);*/
            }
            .all-none { color: blue; }
            .all-none-container { display: inline-block; padding: 0 5px;}
        </style>

        <paper-tooltip position="top">
            [[configProfile.documentation.description]]
        </paper-tooltip>
        <iron-pages
                selected="[[dataType]]"
                attr-for-selected="name"
                role="XXX"
                fallback-selection="other"
                id="iron-pages">

            <paper-input
                    name="object"
                    disabled
                    value="[[_str()]]"
                    label="[[configProfile.name]]">
            </paper-input>

            <paper-material
                    elevation="1"
                    animated
                    name="array"
                    on-mouseleave="_drop"
                    on-mouseenter="_pop">
                <div>
                    <label>
                        [[configProfile.name]]
                    </label>
                    <span class="all-none-container">
                    <paper-button on-tap= "_selectAll" class="all-none">all</paper-button>
                    <paper-button on-tap="_clearAll" class="all-none">none</paper-button>
                    </span>
                </div>
                <template is="dom-if" if="[[checkboxList]]">
                    <template is="dom-repeat" items="[[checkboxList]]">
                        <paper-checkbox
                                on-change="_checkboxChanged"
                                value="[[item]]"
                                checked="checked"
                                name="[[configProfile.name]]">
                            [[_named(item)]]
                        </paper-checkbox>
                    </template>
                </template>
            </paper-material>

            <paper-material
                    elevation="1"
                    animated
                    name="other"
                    on-mouseleave="_drop"
                    on-mouseenter="_pop">
                <paper-input
                        on-change="_otherChanged"
                        label="[[configProfile.name]]"
                        disabled="[[configProfile.meta.read-only]]"
                        name="[[configProfile.name]]"
                        value="[[value]]">
                </paper-input>
            </paper-material>
        </iron-pages>

    </template>
    <script>
        class NclkConfigEditor extends Polymer.mixinBehaviors([
            Polymer.IronFormElementBehavior
        ], Polymer.Element) {
            static get is() { return "nclk-config-editor"; }

            static get properties() {
                return {
                    checkboxList: {
                        type: Array
                    },
                    dataType: {
                        type: String
                    },
                    configProfile: {
                        type: Object,
                        observer: "_configProfileChanged",
                        notify: true
                    },
                    default: {
                        type: Object
                    }
                };
            }

            _str() {
                return JSON.stringify(this._data(), false, 2);
            }

            _arrayItemChecked(item, meta) {
                const it = item && item.name || item;
                const checked = !meta
                    ? true
                    : meta.filter
                    ? ~meta.filter.indexOf(it)
                    : meta.remove
                    ? !~meta.remove.indexOf(it)
                    : true;
                return checked;
            }

            _defaultChanged(d) {
                if (d) {
                    //if (Type.isArray(d)) {
                    if (this.dataType === "array") {
                        this._clearAll();
                        this._checkboxes().forEach((c) => {
                            d.forEach((d) => {
                                if (this._named(c.value) === this._named(d)) {
                                    c.checked = true;
                                    c.dispatchEvent(new Event("change"));
                                }
                            });
                        });
                    }
                    else {
                        //console.log("dc", d, this._data());
                        this._data(d);
                    }
                }
            }

            _checkboxes() {
                return this.checkboxes = this.checkboxes && this.checkboxes.length
                    ? this.checkboxes
                    : this.shadowRoot.querySelectorAll("paper-checkbox");
            }

            _clearAll(e) {
                Array.prototype.forEach.call(this._checkboxes(), x => {
                    x.checked = false;
                    x.dispatchEvent(new Event("change"));
                });
                //this._data().splice(0, this._data().length);
            }

            _selectAll(e) {
                this._clearAll();
                Array.prototype.map.call(this._checkboxes(), x =>
                    (x.checked = true) && this._data().push(x.value)
                );
            }

            _otherChanged(e) {
                const val = e.target.value;
                const parsed = parseInt(val);
                if (parsed)
                    this._data(parsed);
                else this._data(val);
            }

            _checkboxChanged(e) {
                const val = e.target.value;
                const on = e.target.checked;
                const data = this._data();
                const idx = data.indexOf(val);
                if (on) 
                    !~idx && data.push(val);
                else
                    ~idx && data.splice(data.indexOf(val), 1);
            }

            _pop(e) {
                e.target.elevation = 3;
                console.log(this._data(), this.checkboxList, this._checkboxes());
            }

            _drop(e) {
                e.target.elevation = 1;
            }

            _isList() {
                return Type.isArray(this._data());
            }

            _named(item) {
                return item && item.name || item;
            }

            _data(x) {
                return this.value = x
                    ? x
                    : this.value
                        ? this.value
                        : this.configProfile.data[
                            Object.keys(this.configProfile.data)[0]
                        ];
            }

            _sortArrayValue(value) {
                return value.sort((a, b) =>
                    Type.isString(a.name)
                        ? a.name.localeCompare(b.name)
                        : Type.isString(a.id)
                        ? a.id.localeCompare(b.id)
                        : Type.isString(a)
                        ? a.localeCompare(b)
                        : Type.isNumber(a)
                        ? a - b
                        : 0
                );
            }

            _filterArrayValue(value) {
                if (this.default) {
                    return;
                }

                const meta = this.configProfile.meta;
                Array.prototype.forEach.call(this._checkboxes(), x => {
                    x.checked = !meta
                        ? true
                        : meta.filter
                            ? ~meta.filter.indexOf(this._named(x.value))
                            : meta.remove
                                ? !~meta.remove.indexOf(this._named(x.value))
                                : true
                    x.dispatchEvent(new Event("change"));
                });
            }

            _configProfileChanged(cp) {
                const data = this._data(cp.data[Object.keys(cp.data)[0]]);
                this.dataType = Type.type(data);
                if (this.dataType === "array") {
                    console.log(this.configProfile.name + "1", this.checkboxList);
                    this.set("checkboxList", this._sortArrayValue(data.slice()));
                    console.log(this.configProfile.name, this.checkboxList);
                    //this._sortArrayValue(data);
                    setTimeout(() => {
                        this._filterArrayValue(data);
                        console.log(this.configProfile.name + "2", this.checkboxList);
                        setTimeout(() => {
                            this._defaultChanged(this.default);
                        }, 0);
                    }, 0);
                } else {
                    this._defaultChanged(this.default);
                }
            }

        }
        customElements.define(NclkConfigEditor.is, NclkConfigEditor);
    </script>
</dom-module>
